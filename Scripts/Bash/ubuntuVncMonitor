#!/bin/bash

# Ensure the script is run as root
if [ "$EUID" -ne 0 ]; then 
  echo "Please run as root (use sudo)"
  exit
fi

echo "--- Step 1: Installing Dummy Video Driver ---"
apt update && apt install -y xserver-xorg-video-dummy

echo "--- Step 2: Creating /etc/X11/xorg.dummy.conf ---"
cat <<EOF > /etc/X11/xorg.dummy.conf
Section "Device"
    Identifier  "Configured Video Device"
    Driver      "dummy"
    VideoRam    256000
EndSection

Section "Monitor"
    Identifier  "Configured Monitor"
    HorizSync   5.0 - 1000.0
    VertRefresh 5.0 - 200.0
    ModeLine    "1920x1080" 148.50 1920 2448 2492 2640 1080 1084 1089 1125 +Hsync +Vsync
EndSection

Section "Screen"
    Identifier  "Default Screen"
    Monitor     "Configured Monitor"
    Device      "Configured Video Device"
    DefaultDepth 24
    SubSection "Display"
        Depth 24
        Modes "1920x1080" "1440x900" "1280x800" "1024x768"
    EndSubSection
EndSection
EOF

echo "--- Step 3: Creating Detection Script /usr/local/bin/monitorCheck ---"
cat <<'EOF' > /usr/local/bin/monitorCheck
#!/bin/bash
DUMMY_CONF="/etc/X11/xorg.dummy.conf"
TARGET_CONF="/etc/X11/xorg.conf"

echo "Starting monitor detection check..."

# Check if ANY physical port is connected
if grep -q "^connected$" /sys/class/drm/*/status; then
    echo "PHYSICAL MONITOR DETECTED."
    if [ -e "$TARGET_CONF" ] || [ -L "$TARGET_CONF" ]; then
        rm "$TARGET_CONF"
        echo "Removed $TARGET_CONF to allow hardware auto-detection."
    else
        echo "No $TARGET_CONF found; system is already in hardware mode."
    fi
else
    echo "NO MONITOR DETECTED. Setting up VNC Dummy mode."
    if [ -f "$DUMMY_CONF" ]; then
        ln -sf "$DUMMY_CONF" "$TARGET_CONF"
        echo "Created symlink: $TARGET_CONF -> $DUMMY_CONF"
    else
        echo "ERROR: $DUMMY_CONF not found!"
        exit 1
    fi
fi
EOF

# Make the detection script executable
chmod +x /usr/local/bin/monitorCheck

echo "--- Step 4: Creating Systemd Service ---"
cat <<EOF > /etc/systemd/system/xorg-check.service
[Unit]
Description=Check for monitor and swap xorg.conf
Before=display-manager.service

[Service]
Type=oneshot
ExecStart=/usr/local/bin/monitorCheck
RemainAfterExit=yes

[Install]
WantedBy=multi-user.target
EOF

echo "--- Step 5: Enabling Service ---"
systemctl daemon-reload
systemctl enable xorg-check.service

echo "------------------------------------------------"
echo "SETUP COMPLETE!"
echo "Current Status:"
/usr/local/bin/monitorCheck
echo "------------------------------------------------"