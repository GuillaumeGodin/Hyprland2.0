#!/bin/bash

# --- Functions ---

# Displays help information
show_help() {
    echo "Usage: ./ubuntuTimeshift [COMMAND]"
    echo ""
    echo "Commands:"
    echo "  installTimeshift   Installs Timeshift via official PPA."
    echo "  removeTimeshift    Completely removes Timeshift and its PPA."
    echo "  daily              Sets up a daily backup schedule (keeps last 7)."
    echo "  status             Shows current snapshots and disk space."
    echo "  create             Manually creates a new snapshot immediately."
    echo "  -h, --help         Displays this help message."
    echo ""
}

# Installs Timeshift and its dependencies
install_timeshift() {
    echo "------------------------------------------"
    echo "  Installing Timeshift..."
    echo "------------------------------------------"
    sudo apt update -y
    sudo apt install -y software-properties-common
    sudo add-apt-repository -y ppa:teejee2008/timeshift
    sudo apt update -y
    sudo apt install -y timeshift
    echo "------------------------------------------"
    echo "  Installation Complete!"
    echo "------------------------------------------"
}

# Removes Timeshift and cleans up the PPA
remove_timeshift() {
    echo "------------------------------------------"
    echo "  Removing Timeshift..."
    echo "------------------------------------------"
    sudo apt purge -y timeshift
    echo "Removing PPA repository..."
    sudo add-apt-repository --remove -y ppa:teejee2008/timeshift
    sudo apt autoremove -y
    echo "------------------------------------------"
    echo "  Timeshift has been fully removed."
    echo "------------------------------------------"
}

# Configures 7-day daily backups via JSON config
setup_daily_backups() {
    echo "------------------------------------------"
    echo "  Configuring Daily Schedule (Keep 7)"
    echo "------------------------------------------"
    
    if ! command -v timeshift &> /dev/null; then
        echo "Error: Timeshift is not installed. Run 'installTimeshift' first."
        exit 1
    fi

    sudo timeshift --check > /dev/null 2>&1
    sudo sed -i 's/"schedule_daily" : "false"/"schedule_daily" : "true"/' /etc/timeshift/timeshift.json
    sudo sed -i 's/"count_daily" : "[0-9]*"/"count_daily" : "7"/' /etc/timeshift/timeshift.json
    sudo timeshift --check

    echo "------------------------------------------"
    echo "  Success! Daily backups are enabled."
    echo "------------------------------------------"
}

# Shows the status of current snapshots
show_status() {
    echo "------------------------------------------"
    echo "  Current Snapshot Status"
    echo "------------------------------------------"
    if ! command -v timeshift &> /dev/null; then
        echo "Timeshift is not installed."
    else
        sudo timeshift --list
    fi
}

# Manually creates a snapshot
create_snapshot() {
    echo "------------------------------------------"
    echo "  Creating Manual Snapshot..."
    echo "------------------------------------------"
    sudo timeshift --create --comments "Manual Backup" --tags O
    echo "------------------------------------------"
    echo "  Snapshot Created Successfully!"
    echo "------------------------------------------"
}

# --- Command Logic ---

case "$1" in
    installTimeshift)
        install_timeshift
        ;;
    removeTimeshift)
        remove_timeshift
        ;;
    daily)
        setup_daily_backups
        ;;
    status)
        show_status
        ;;
    create)
        create_snapshot
        ;;
    -h|--help)
        show_help
        ;;
    *)
        echo "Invalid option: $1"
        show_help
        exit 1
        ;;
esac