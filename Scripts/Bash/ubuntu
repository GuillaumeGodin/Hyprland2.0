#!/bin/bash

case "$1" in
    -h|--help)
        echo "Usage: ./ubuntu [command]"
        echo ""
        echo "Commands:"
        echo "  installDocker       Installs Docker Engine and Compose"
        echo "  removeDocker        Completely removes Docker from system"
        echo "  removeDockerApps    Stops and removes ALL app containers in this script"
        echo "  installPortainer    Setup Portainer (GUI) on port 8000 & 9443"
        echo "  removePortainer     Stop and remove Portainer container"
        echo "  installQDirStat     Setup QDirStat (Storage Visualizer) on port 3000"
        echo "  removeQDirStat      Stop and remove QDirStat container"
        echo "  installJellyfin     Setup Jellyfin (VAAPI) on port 5000"
        echo "  removeJellyfin      Stop and remove Jellyfin container"
        echo "  installPhotoPrism   Setup PhotoPrism on port 5001"
        echo "  removePhotoPrism    Stop and remove PhotoPrism container"
        echo "  installNavidrome    Setup Navidrome (Music) on port 5002"
        echo "  removeNavidrome     Stop and remove Navidrome container"
        echo "  installTandoor      Setup Tandoor Recipes on port 5003 (DB) & 5004 (Web)"
        echo "  removeTandoor       Stop and remove Tandoor & Postgres containers"
        echo "  installCalibre      Setup Calibre-Web-Automated on port 5005"
        echo "  removeCalibre       Stop and remove Calibre container"
        echo "  installCalibreDL    Setup Calibre Downloader on port 5006"
        echo "  removeCalibreDL     Stop and remove Calibre Downloader container"
        echo "  installJackett      Setup Jackett (Indexers) on port 5050"
        echo "  removeJackett       Stop and remove Jackett container"
        echo "  installProwlarr     Setup Prowlarr (Indexers) on port 5051"
        echo "  removeProwlarr      Stop and remove Prowlarr container"
        echo "  installSabnzbd      Setup Sabnzbd (Usenet) on port 5052"
        echo "  removeSabnzbd       Stop and remove Sabnzbd container"
        echo "  installRadarr       Setup Radarr (Movies) on port 5053"
        echo "  removeRadarr        Stop and remove Radarr container"
        echo "  installSonarr       Setup Sonarr (TV Shows) on port 5054"
        echo "  removeSonarr        Stop and remove Sonarr container"
        echo "  installLidarr       Setup Lidarr (Music) on port 5055"
        echo "  removeLidarr        Stop and remove Lidarr container"
        echo "  installBazarr       Setup Bazarr (Subtitles) on port 5056"
        echo "  removeBazarr        Stop and remove Bazarr container"
        echo "  installQbittorrent  Setup qBittorrent on port 5080"
        echo "  removeQbittorrent   Stop and remove qBittorrent container"
        echo "  installDeluge       Setup Deluge on port 5090"
        echo "  removeDeluge        Stop and remove Deluge container"
        echo "  installHomeAssistant Setup Home Assistant on port 8123"
        echo "  removeHomeAssistant  Stop and remove Home Assistant container"
        echo "  installMotionEye    Setup motionEye (CCTV) on port 8765"
        echo "  removeMotionEye     Stop and remove motionEye container"
        ;;

    installDocker)
        echo "Installing Docker Engine..."
        sudo apt update
        sudo apt install -y ca-certificates curl gnupg
        sudo install -m 0755 -d /etc/apt/keyrings
        curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
        sudo chmod a+r /etc/apt/keyrings/docker.gpg
        echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
        sudo apt update
        sudo apt install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
        sudo usermod -aG docker $USER
        echo "Installation Complete! Running test..."
        sudo docker run hello-world
        echo "IMPORTANT: Log out and back in to use docker without sudo."
        ;;

    removeDocker)
        echo "Removing Docker Engine and all data..."
        docker stop $(docker ps -aq) 2>/dev/null
        docker system prune -a --volumes --force 2>/dev/null
        sudo apt-get purge -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
        sudo rm -rf /var/lib/docker /var/lib/containerd /etc/docker ~/.docker
        sudo rm /etc/apt/sources.list.d/docker.list /etc/apt/keyrings/docker.gpg 2>/dev/null
        sudo apt-get autoremove -y
        echo "Docker Engine removed."
        ;;

    removeDockerApps)
        echo "Stopping and removing all containers defined in this script..."
        
        APPS="portainer qdirstat jellyfin photoprism navidrome tandoor db_recipes calibre-web-automated caliber-web-automated-downloader jackett prowlarr sabnzbd radarr sonarr lidarr bazarr qbittorrent deluge homeassistant motioneye"
        
        for app in $APPS; do
            if [ "$(docker ps -aq -f name=^/${app}$)" ]; then
                echo "Removing $app..."
                docker stop $app 2>/dev/null
                docker rm $app 2>/dev/null
            fi
        done
        
        docker network rm tandoor_network 2>/dev/null
        echo "All app containers have been removed."
        ;;

    installPortainer)
        echo "Setting up Portainer on ports 8000 and 9443..."
        sudo docker volume create portainer_data

        docker run -d \
          --name portainer \
          -p 8000:8000 \
          -p 9443:9443 \
          -v /var/run/docker.sock:/var/run/docker.sock \
          -v portainer_data:/data \
          --restart=always \
          portainer/portainer-ce:latest

        echo "Portainer ready! Access HTTP on 8000 or HTTPS on 9443."
        ;;

    removePortainer)
        docker stop portainer 2>/dev/null && docker rm portainer 2>/dev/null
        echo "Portainer container removed."
        ;;

    installQDirStat)
        echo "Setting up QDirStat on port 3000..."
        mkdir -p /home/$USER/Docker/qdirstat/config

        docker run -d \
          --name=qdirstat \
          -e PUID=1000 \
          -e PGID=1000 \
          -e TZ="America/Toronto" \
          -p 3000:3000 \
          -p 3001:3001 \
          -v /home/$USER/Docker/qdirstat/config:/config \
          -v /media/md0:/data \
          --shm-size="1gb" \
          --restart unless-stopped \
          lscr.io/linuxserver/qdirstat:latest

        echo "QDirStat running on port 3000!"
        ;;

    removeQDirStat)
        docker stop qdirstat 2>/dev/null && docker rm qdirstat 2>/dev/null
        echo "QDirStat container removed."
        ;;

    installJellyfin)
        echo "Setting up Jellyfin (VAAPI) on 5000..."
        mkdir -p /home/$USER/Docker/jellyfin/{config,cache,media}
        
        sudo docker run -d \
          --name jellyfin \
          --privileged \
          -e PUID=$(id -u) \
          -e PGID=$(id -g) \
          -e GROUP_ADD=110,44 \
          -e JELLYFIN_VAAPI_DEVICE=/dev/dri/renderD128 \
          --device /dev/dri:/dev/dri \
          --device /dev/dri/renderD128:/dev/dri/renderD128 \
          --device /dev/dri/card1:/dev/dri/card1 \
          -p 5000:8096 \
          -v /home/$USER/Docker/jellyfin/config:/config \
          -v /home/$USER/Docker/jellyfin/cache:/cache \
          -v /home/$USER/Docker/jellyfin/media:/media \
          -v /media/md0:/md0 \
          --restart unless-stopped \
          jellyfin/jellyfin:latest
          
        echo "Jellyfin running on port 5000!"
        ;;

    removeJellyfin)
        docker stop jellyfin 2>/dev/null && docker rm jellyfin 2>/dev/null
        echo "Jellyfin container removed."
        ;;

    installPhotoPrism)
        echo "Setting up PhotoPrism on 5001..."
        mkdir -p /home/$USER/Docker/photoprism/{photos,storage}

        docker run -d \
          --name photoprism \
          -p 5001:2342 \
          -e PHOTOPRISM_ADMIN_PASSWORD="yourpassword" \
          -e PHOTOPRISM_DEBUG="false" \
          -e PHOTOPRISM_PUBLIC="false" \
          -v /home/$USER/Docker/photoprism/photos:/photoprism/originals \
          -v /home/$USER/Docker/photoprism/storage:/photoprism/storage \
          -v /media/md0:/md0 \
          --restart=unless-stopped \
          photoprism/photoprism:latest

        echo "PhotoPrism running on port 5001!"
        ;;

    removePhotoPrism)
        docker stop photoprism 2>/dev/null && docker rm photoprism 2>/dev/null
        echo "PhotoPrism container removed."
        ;;

    installNavidrome)
        echo "Setting up Navidrome on 5002..."
        mkdir -p /home/$USER/Docker/navidrome/{music,config}

        docker run -d \
          --name navidrome \
          -p 5002:4533 \
          -e ND_LOGLEVEL=info \
          -v /media/md0:/music \
          -v /home/$USER/Docker/navidrome/config:/config \
          -v /media/md0:/md0 \
          --restart=unless-stopped \
          deluan/navidrome:latest

        echo "Navidrome running on port 5002!"
        ;;

    removeNavidrome)
        docker stop navidrome 2>/dev/null && docker rm navidrome 2>/dev/null
        echo "Navidrome container removed."
        ;;

    installTandoor)
        echo "Setting up Tandoor Recipes..."
        mkdir -p /home/$USER/Docker/tandoor/{staticfiles,mediafiles,postgresql}
        docker network create tandoor_network 2>/dev/null

        docker run -d \
            --name db_recipes \
            --network tandoor_network \
            -p 5003:5432 \
            -e POSTGRES_USER=admin \
            -e POSTGRES_PASSWORD="admin" \
            -e POSTGRES_DB=djangodb \
            -v /home/$USER/Docker/tandoor/postgresql:/var/lib/postgresql/data \
            --restart unless-stopped \
            postgres:14

        docker run -d \
            --name tandoor \
            --network tandoor_network \
            -p 5004:80 \
            -e SECRET_KEY="Ko6EaBPDROfILwNzeENdDVDTBo_SrdsGE0goTo0F3AiFSDCpf0uTlgWzv11HMSZGdhs" \
            -e DB_ENGINE=django.db.backends.postgresql \
            -e POSTGRES_HOST=db_recipes \
            -e POSTGRES_PORT=5432 \
            -e POSTGRES_USER=admin \
            -e POSTGRES_PASSWORD="admin" \
            -e POSTGRES_DB=djangodb \
            -v /home/$USER/Docker/tandoor/staticfiles:/opt/recipes/staticfiles \
            -v /home/$USER/Docker/tandoor/mediafiles:/opt/recipes/mediafiles \
            --restart unless-stopped \
            vabene1111/recipes

        echo "Tandoor is ready! WebUI on port 5004, DB on port 5003."
        ;;

    removeTandoor)
        docker stop tandoor db_recipes 2>/dev/null
        docker rm tandoor db_recipes 2>/dev/null
        docker network rm tandoor_network 2>/dev/null
        echo "Tandoor containers and network removed."
        ;;

    installCalibre)
        echo "Setting up Calibre-Web-Automated on port 5005..."
        mkdir -p /home/$USER/Docker/calibre-web-automated/{config,calibre-library,ingest}

        docker run -d \
          --name=calibre-web-automated \
          --network=bridge \
          -p 5005:8083 \
          -e PUID=1000 \
          -e PGID=1000 \
          -e TZ="America/Toronto" \
          -v /home/$USER/Docker/calibre-web-automated/config:/config \
          -v /home/$USER/Docker/calibre-web-automated/calibre-library:/calibre-library \
          -v /home/$USER/Docker/calibre-web-automated/ingest:/cwa-book-ingest \
          --restart unless-stopped \
          crocodilestick/calibre-web-automated:latest

        echo "Calibre-Web-Automated running on port 5005!"
        echo "User: admin"
        echo "Password: admin123"
        ;;

    removeCalibre)
        docker stop calibre-web-automated 2>/dev/null && docker rm calibre-web-automated 2>/dev/null
        echo "Calibre-Web-Automated removed."
        ;;

    installCalibreDL)
        echo "Setting up Calibre Downloader on port 5006..."
        mkdir -p /home/$USER/Docker/calibre-web-automated/ingest

        docker run -d \
          --name=caliber-web-automated-downloader \
          --network=bridge \
          -p 5006:8084 \
          -e FLASK_PORT=8084 \
          -e LOG_LEVEL=info \
          -e BOOK_LANGUAGE=en \
          -e TZ="America/Toronto" \
          -e UID=1000 \
          -e GID=1000 \
          -v /home/$USER/Docker/calibre-web-automated/ingest:/cwa-book-ingest \
          --restart unless-stopped \
          ghcr.io/calibrain/calibre-web-automated-book-downloader:latest

        echo "Calibre Downloader running on port 5006!"
        ;;

    removeCalibreDL)
        docker stop caliber-web-automated-downloader 2>/dev/null && docker rm caliber-web-automated-downloader 2>/dev/null
        echo "Calibre Downloader removed."
        ;;

    installJackett)
        echo "Setting up Jackett on 5050..."
        mkdir -p /home/$USER/Docker/jackett/{config,downloads}

        docker run -d \
          --name jackett \
          -p 5050:9117 \
          -e PUID=1000 \
          -e PGID=1000 \
          -e TZ="America/Toronto" \
          -v /home/$USER/Docker/jackett/config:/config \
          -v /home/$USER/Docker/jackett/downloads:/downloads \
          --restart unless-stopped \
          lscr.io/linuxserver/jackett:latest

        echo "Jackett running on port 5050!"
        ;;

    removeJackett)
        docker stop jackett 2>/dev/null && docker rm jackett 2>/dev/null
        echo "Jackett container removed."
        ;;

    installProwlarr)
        echo "Setting up Prowlarr on 5051..."
        mkdir -p /home/$USER/Docker/prowlarr/{config,downloads,media}

        docker run -d \
          --name prowlarr \
          --network=bridge \
          -p 5051:9696 \
          -e PUID=1000 \
          -e PGID=1000 \
          -e TZ="America/Toronto" \
          -v /home/$USER/Docker/prowlarr/config:/config \
          -v /home/$USER/Docker/prowlarr/downloads:/downloads \
          -v /home/$USER/Docker/prowlarr/media:/media \
          -v /media/md0:/md0 \
          --restart unless-stopped \
          linuxserver/prowlarr

        echo "Prowlarr running on port 5051!"
        ;;

    removeProwlarr)
        docker stop prowlarr 2>/dev/null && docker rm prowlarr 2>/dev/null
        echo "Prowlarr container removed."
        ;;

    installSabnzbd)
        echo "Setting up Sabnzbd on 5052..."
        mkdir -p /home/$USER/Docker/sabnzbd/{config,downloads,incomplete}

        docker run -d \
          --name sabnzbd \
          --network=bridge \
          -p 5052:8080 \
          -e PUID=1000 \
          -e PGID=1000 \
          -e TZ="America/Toronto" \
          -v /home/$USER/Docker/sabnzbd/config:/config \
          -v /home/$USER/Docker/sabnzbd/downloads:/downloads \
          -v /home/$USER/Docker/sabnzbd/incomplete:/incomplete \
          -v /media/md0:/md0 \
          --restart unless-stopped \
          linuxserver/sabnzbd

        echo "Sabnzbd running on port 5052!"
        ;;

    removeSabnzbd)
        docker stop sabnzbd 2>/dev/null && docker rm sabnzbd 2>/dev/null
        echo "Sabnzbd container removed."
        ;;

    installRadarr)
        echo "Setting up Radarr on 5053..."
        mkdir -p /home/$USER/Docker/radarr/{config,movies}

        docker run -d \
          --name radarr \
          -p 5053:7878 \
          -e PUID=1000 \
          -e PGID=1000 \
          -v /home/$USER/Docker/radarr/config:/config \
          -v /home/$USER/Docker/radarr/movies:/movies \
          -v /media/md0:/md0 \
          -v /media/md0/Media/Media_Arr/Deluge:/Deluge \
          --restart=unless-stopped \
          linuxserver/radarr:latest

        echo "Radarr running on port 5053!"
        ;;

    removeRadarr)
        docker stop radarr 2>/dev/null && docker rm radarr 2>/dev/null
        echo "Radarr container removed."
        ;;

    installSonarr)
        echo "Setting up Sonarr on 5054..."
        mkdir -p /home/$USER/Docker/sonarr/{config,tv}

        docker run -d \
          --name sonarr \
          -p 5054:8989 \
          -e PUID=1000 \
          -e PGID=1000 \
          -v /home/$USER/Docker/sonarr/config:/config \
          -v /home/$USER/Docker/sonarr/tv:/tv \
          -v /media/md0:/md0 \
          -v /media/md0/Media/Media_Arr/Deluge:/Deluge \
          --restart=unless-stopped \
          linuxserver/sonarr:latest

        echo "Sonarr running on port 5054!"
        ;;

    removeSonarr)
        docker stop sonarr 2>/dev/null && docker rm sonarr 2>/dev/null
        echo "Sonarr container removed."
        ;;

    installLidarr)
        echo "Setting up Lidarr on port 5055..."
        mkdir -p /home/$USER/Docker/lidarr/{config,music,downloads}

        docker run -d \
          --name=lidarr \
          --network=bridge \
          -p 5055:8686 \
          -e PUID=1000 \
          -e PGID=1000 \
          -e TZ="America/Toronto" \
          -v /home/$USER/Docker/lidarr/config:/config \
          -v /home/$USER/Docker/lidarr/music:/music \
          -v /home/$USER/Docker/lidarr/downloads:/downloads \
          -v /media/md0:/md0 \
          -v /media/md0/Media/Media_Arr/Deluge:/Deluge \
          --restart unless-stopped \
          linuxserver/lidarr:latest

        echo "Lidarr running on port 5055!"
        ;;

    removeLidarr)
        docker stop lidarr 2>/dev/null && docker rm lidarr 2>/dev/null
        echo "Lidarr container removed."
        ;;

    installBazarr)
        echo "Setting up Bazarr on port 5056..."
        mkdir -p /home/$USER/Docker/bazarr/{config,downloads,media}

        docker run -d \
          --name=bazarr \
          --network=bridge \
          -p 5056:6767 \
          -e PUID=1000 \
          -e PGID=1000 \
          -e TZ="America/Toronto" \
          -v /home/$USER/Docker/bazarr/config:/config \
          -v /home/$USER/Docker/bazarr/downloads:/downloads \
          -v /home/$USER/Docker/bazarr/media:/media \
          -v /media/md0:/md0 \
          --restart unless-stopped \
          linuxserver/bazarr:latest

        echo "Bazarr running on port 5056!"
        ;;

    removeBazarr)
        docker stop bazarr 2>/dev/null && docker rm bazarr 2>/dev/null
        echo "Bazarr container removed."
        ;;

    installQbittorrent)
        echo "Starting qBittorrent to generate initial files..."
        mkdir -p /home/$USER/Docker/qbittorrent/config/qBittorrent/
        mkdir -p /home/$USER/Docker/qbittorrent/downloads
        
        docker run -d \
          --name qbittorrent \
          -p 5080:8080 \
          -p 6881:6881 \
          -p 6881:6881/udp \
          -e PUID=1000 \
          -e PGID=1000 \
          -e TZ="America/Toronto" \
          -e WEBUI_PORT=8080 \
          -v /home/$USER/Docker/qbittorrent/config:/config \
          -v /home/$USER/Docker/qbittorrent/downloads:/downloads \
          -v /media/md0/Media/Media_Arr/Deluge:/Deluge \
          --restart unless-stopped \
          lscr.io/linuxserver/qbittorrent:latest

        echo "Waiting for config (10s)..."
        sleep 10
        docker stop qbittorrent

        CONF_FILE="/home/$USER/Docker/qbittorrent/config/qBittorrent/qBittorrent.conf"
        if grep -q "\[Preferences\]" "$CONF_FILE"; then
            sudo sed -i '/\[Preferences\]/a WebUI\\HostHeaderValidation=false\nWebUI\\CSRFProtection=false' "$CONF_FILE"
        else
            echo -e "\n[Preferences]\nWebUI\\HostHeaderValidation=false\nWebUI\\CSRFProtection=false" | sudo tee -a "$CONF_FILE" > /dev/null
        fi

        docker start qbittorrent
        echo "qBittorrent ready on port 5080!"
        ;;

    removeQbittorrent)
        docker stop qbittorrent 2>/dev/null && docker rm qbittorrent 2>/dev/null
        echo "qBittorrent container removed."
        ;;

    installDeluge)
        echo "Setting up Deluge on port 5090..."
        mkdir -p /home/$USER/Docker/deluge/{config,downloads}

        docker run -d \
          --name=deluge \
          --restart unless-stopped \
          -p 5090:8112 \
          -p 55555:6881 \
          -p 55555:6881/udp \
          -e PUID=1000 \
          -e PGID=1000 \
          -e TZ="America/Toronto" \
          -v /home/$USER/Docker/deluge/config:/config \
          -v /home/$USER/Docker/deluge/downloads:/downloads \
          -v /media/md0/Media/Media_Arr/Deluge:/Deluge \
          lscr.io/linuxserver/deluge:latest
          
        echo "Deluge running on port 5090!"
        ;;

    removeDeluge)
        docker stop deluge 2>/dev/null && docker rm deluge 2>/dev/null
        echo "Deluge container removed."
        ;;

    installHomeAssistant)
        echo "Setting up Home Assistant on port 8123..."
        mkdir -p /home/$USER/Docker/homeassistant/config

        docker run -d \
          --name homeassistant \
          --network=host \
          -e TZ="America/Toronto" \
          -v /home/$USER/Docker/homeassistant/config:/config \
          --privileged \
          --restart unless-stopped \
          ghcr.io/home-assistant/home-assistant:stable

        echo "Home Assistant running on port 8123!"
        ;;

    removeHomeAssistant)
        docker stop homeassistant 2>/dev/null && docker rm homeassistant 2>/dev/null
        echo "Home Assistant container removed."
        ;;

    installMotionEye)
        echo "Setting up motionEye on port 8765..."
        mkdir -p /home/$USER/Docker/motioneye/MotionEye
        mkdir -p /home/$USER/Docker/motioneye/MotionEye/etc

        docker run -d \
          --name=motioneye \
          --restart=always \
          -p 8765:8765 \
          -v /home/$USER/Docker/motioneye/MotionEye:/MotionEye \
          -v /home/$USER/Docker/motioneye/MotionEye/etc:/etc/motioneye \
          -v /etc/localtime:/etc/localtime:ro \
          ghcr.io/motioneye-project/motioneye:edge

        echo "motionEye running on port 8765!"
        echo "User: admin"
        echo "Password: leave blank"
        ;;

    removeMotionEye)
        docker stop motioneye 2>/dev/null && docker rm motioneye 2>/dev/null
        echo "motionEye container removed."
        ;;

    *)
        echo "Error: Invalid argument '$1'"
        echo "Use ./ubuntu -h for help."
        exit 1
        ;;
esac