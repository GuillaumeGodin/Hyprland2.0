#!/bin/bash

# 1. Get current Power Profile from asusctl
get_status() {
    PWR=$(asusctl profile -p | sed -n -e 's/^.*Active profile is //p')
}

get_status

# 2. Logic for Display (Waybar)
if [ "$PWR" == "Quiet" ]; then
    text="󰾆"
    tooltip="Quiet Mode + Integrated GPU"
elif [ "$PWR" == "Balanced" ]; then
    text="󰾅"
    tooltip="Balanced Mode + Hybrid GPU"
elif [ "$PWR" == "Performance" ]; then
    text="󰓅"
    tooltip="Performance Mode + Dedicated GPU"
fi

echo '{"text": "'$text'", "tooltip": "'$tooltip'"}'

# 3. Toggle Logic
if [[ "$1" == "next" ]]; then
    # Cycle the asusctl profile first
    asusctl profile -n
    get_status # Refresh the PWR variable with the new profile
    
    # Apply the corresponding GPU mode
    case "$PWR" in
        "Quiet")
            # This runs the command in the background, independent of this script
            systemd-run --user --machine=%u /usr/bin/supergfxctl -m Integrated
            GPU_MSG="Integrated GPU"
            ;;
        "Balanced")
            systemd-run --user --machine=%u /usr/bin/supergfxctl -m Hybrid
            GPU_MSG="Hybrid GPU"
            ;;
        "Performance")
            # WARNING: This might still trigger a reboot if your laptop has a MUX
            systemd-run --user --machine=%u /usr/bin/supergfxctl -m AsusMuxDgpu
            GPU_MSG="Dedicated GPU"
            ;;
    esac

    # Update Waybar and Notify
    pkill -SIGRTMIN+8 waybar
    notify-send -h string:x-canonical-private-synchronous:sys-notify -u normal \
        "Profile: $PWR" "GPU switched to $GPU_MSG"
fi