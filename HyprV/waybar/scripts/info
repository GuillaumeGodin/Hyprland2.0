#!/bin/bash

# --- YOUR LOCATION (SYSTEM BASED) ---
# Instead of guessing by IP, we use your system's set timezone
# America/Toronto usually maps to Ottawa/Toronto area
location_raw=$(timedatectl | grep "Time zone" | awk '{print $3}')
city="Ottawa"
region="Ontario"
country="CA"

# We still get the Public IP just for the tooltip info
privateIP=$(curl -s ifconfig.co)

# --- LOCAL NETWORK INFO ---
connectionName=$(nmcli device show | grep -o 'GENERAL.DEVICE.*' | cut -d: -f2 | awk '{print $1}' | head -1)
connectionIP=$(nmcli device show | grep -o 'IP4.ADDRESS.*' | cut -d: -f2 | awk '{print $1}' | head -1)

# --- MARKET DATA SECTION (NDX FIXED) ---
get_stock() {
    # -H User-Agent is critical to stop Yahoo from blocking the script
    data=$(curl -s -L -H "User-Agent: Mozilla/5.0" "https://query1.finance.yahoo.com/v8/finance/chart/$1?interval=1d&range=1d")
    price=$(echo "$data" | jq -r '.chart.result[0].meta.regularMarketPrice // 0')
    prev=$(echo "$data" | jq -r '.chart.result[0].meta.chartPreviousClose // 0')
    echo "$price $prev"
}

read spyPrice spyPrev < <(get_stock "^GSPC")
read dowPrice dowPrev < <(get_stock "^DJI")
read ndxPrice ndxPrev < <(get_stock "^NDX")
read tsxPrice tsxPrev < <(get_stock "^GSPTSE")

calc_pct() {
    if [[ -z "$1" || "$1" == "0" || "$2" == "0" ]]; then
        echo "0.00%"
    else
        # Using bc for precise floating point math
        awk "BEGIN {printf \"%.2f%%\", (($1-$2)/$2)*100}"
    fi
}

spyPct=$(calc_pct "$spyPrice" "$spyPrev")
dowPct=$(calc_pct "$dowPrice" "$dowPrev")
ndxPct=$(calc_pct "$ndxPrice" "$ndxPrev")
tsxPct=$(calc_pct "$tsxPrice" "$tsxPrev")

# --- TOOLTIP GENERATION ---
# Using \r for newlines in Waybar
TOOLTIP="Network:\r"\
"Public IP = $privateIP\r"\
"$city, $region, $country\r"\
"Private IP = $connectionName ($connectionIP)\r\r"\
"Markets:\r"\
"SPY    = $spyPrice ($spyPct)\r"\
"DOW    = $dowPrice ($dowPct)\r"\
"NDX    = $ndxPrice ($ndxPct)\r"\
"TSX    = $tsxPrice ($tsxPct)"

# Final JSON for Waybar
echo "{\"text\": \"$city, $region\", \"tooltip\": \"$TOOLTIP\"}"